<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mustache@4.2.0/mustache.min.js"></script>
    <title>ìª½ì§€ ë° ì±„íŒ…</title>
    <style>
        .chat-popup,
        .note-popup {
            display: none;
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 320px;
            height: 400px;
            background: #fff;
            border: 1px solid #aaa;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            padding: 15px;
            overflow-y: auto;
        }

        #chat-message,
        #note-message {
            width: 75%;
            padding: 6px;
            margin-right: 5px;
        }

        #send-message,
        #send-note {
            padding: 6px 10px;
            cursor: pointer;
        }

        .chat-toggle-btn,
        .note-toggle-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #0066cc;
            color: #fff;
            border-radius: 50%;
            width: 55px;
            height: 55px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            z-index: 1001;
        }

        .note-toggle-btn {
            right: 90px;
        }

        .chat-messages,
        .note-messages {
            margin-top: 40px;
        }

        .sender-message {
            background-color: #e0f7fa;
            padding: 5px 10px;
            margin: 5px 0;
            border-radius: 6px;
            text-align: right;
        }

        .chat-popup {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            max-height: 400px;
        }

        .chat-header {
            background-color: #3498db;
            color: white;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }

        .chat-messages {
            display: flex;
            flex-direction: column;
            padding: 10px;
            overflow-y: auto;
            flex-grow: 1;
        }


        .chat-messages .sender-message {
            align-self: flex-end;
            background-color: #3498db;
            color: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 8px;
            max-width: 70%;
            word-wrap: break-word;
            text-align: right;
        }

        .chat-messages .receiver-message {
            align-self: flex-start;
            background-color: #ecf0f1;
            color: #34495e;
            padding: 10px;
            margin: 5px 0;
            border-radius: 8px;
            max-width: 70%;
            word-wrap: break-word;
            text-align: left;
        }

        /* ì±„íŒ… ì…ë ¥ì°½ê³¼ ì „ì†¡ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .chat-input {
            display: flex;
            gap: 10px;
            /* padding: 10px; */
            border-top: 1px solid #ddd;
        }

        .chat-input input {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .chat-input button {
            padding: 8px 12px;
            background-color: #2c3e50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        /* ì±„íŒ… ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .note-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            background: #f7f7f7;
            display: flex;
            flex-direction: column;
        }

        .note-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 400px;
            /* íŒì—…ì°½ ë†’ì´ */
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            z-index: 9999;
            display: none;
            flex-direction: column;
            /* ì„¸ë¡œ ë°©í–¥ìœ¼ë¡œ ë°°ì¹˜ */
            max-height: 400px;
            box-sizing: border-box;
        }

        .note-sender-bar {
            padding: 10px;
            background-color: #ecf0f1;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            border-bottom: 1px solid #ddd;
        }

        .note-sender-bar input {
            width: 100%;
            box-sizing: border-box;

            padding: 8px;
            font-size: 0.95em;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #f0f0f0;
            color: #666;
        }

        .note-header {
            background-color: #3498db;
            color: white;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .note-close-btn {
            background: none;
            color: white;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
        }

        .note-item {
            background-color: #ecf0f1;
            padding: 10px;
            margin: 5px 0;
            border-radius: 8px;
            max-width: 70%;
            word-wrap: break-word;
        }

        .note-item .sender {
            font-weight: bold;
            color: #34495e;
        }

        .note-item .message {
            margin-top: 5px;
            color: #34495e;
        }

        .note-item .timestamp {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-top: 5px;
            text-align: right;
        }

        .note-input-bar {
            display: flex;
            gap: 8px;
            padding: 10px;
            border-top: 1px solid #ddd;
            background-color: #fff;
            /* ìˆ˜ì •ëœ ë¶€ë¶„ */
            width: 100%;
            box-sizing: border-box;
            /* íŒ¨ë”© í¬í•¨í•œ í¬ê¸° ì§€ì • */
            margin-top: auto;
        }

        /* ì…ë ¥ì°½ */
        .note-input-bar input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        /* ì „ì†¡ ë²„íŠ¼ */
        .note-input-bar button {
            padding: 8px 12px;
            background-color: #2c3e50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .note-input-bar button:hover {
            background-color: #34495e;
        }
    </style>
</head>

<body>
    <div class="floating-buttons">
        <button class="chat-toggle-btn" title="ì±„íŒ… ì—´ê¸°" aria-label="ì±„íŒ… ì—´ê¸°">
            <i class="fas fa-comments"></i>
        </button>
        <button class="note-toggle-btn" title="ìª½ì§€ ì—´ê¸°" aria-label="ìª½ì§€ ì—´ê¸°">
            <i class="fas fa-envelope"></i>
        </button>
    </div>


    <!-- ìª½ì§€ íŒì—… -->
    <div class="note-popup">
        <div class="note-header">
            <span>ìª½ì§€</span>
            <button class="note-close-btn">&times;</button>
        </div>


        <div class="note-nav">
            <button class="received-notes-btn">ë°›ì€ ìª½ì§€</button>
            <button class="sent-notes-btn">ë³´ë‚¸ ìª½ì§€</button>
        </div>

        <div class="note-sender-bar">
            <input type="text" id="note-receiver" placeholder="ë°›ëŠ” ì‚¬ëŒ ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
        </div>
        <!-- í—¤ë”: ë‹«ê¸° ë²„íŠ¼ -->

        <!-- ì¤‘ê°„: ìª½ì§€ ë‚´ìš© -->
        <div class="note-messages">
            <ul>
                {{#notes}}
                <li>ë³´ë‚¸ ì‚¬ëŒ: {{senderId}} - ë‚´ìš©: {{message}}</li>
                {{/notes}}
            </ul>
        </div>

        <!-- í•˜ë‹¨: ë©”ì‹œì§€ ì…ë ¥ ë° ì „ì†¡ -->
        <div class="note-input-bar">
            <input type="text" id="note-message" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." />
            <button id="send-note">ì „ì†¡</button>
        </div>
    </div>

    <!-- ì±„íŒ… íŒì—… -->
    <div class="chat-popup" style="display: none;">
        <div class="chat-header">
            <span class="chat-with">ì‹¤ì‹œê°„ ì±„íŒ…</span>
            <button class="chat-close-btn">&times;</button>
        </div>
        <div class="chat-messages"></div>
        <div class="chat-input">
            <input type="text" id="chat-message" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." />
            <button id="send-message">ì „ì†¡</button>
        </div>
    </div>
    <script>
        $(document).ready(function () {

            // ë©”ì¸í˜ì´ì§€ ì±„íŒ… ë²„íŠ¼ í´ë¦­ ì‹œ
            $('.chat-toggle-btn').on('click', function () {
                $('.chat-popup').fadeIn();
            });

            // ì±„íŒ…ì°½ ë‹«ê¸°
            $('.chat-close-btn').on('click', function () {
                $('.chat-popup').fadeOut();
            });

            // ë©”ì‹œì§€ ì „ì†¡
            $('#send-message').on('click', function () {
                const message = $('#chat-message').val().trim();
                if (!message) return;

                if (!currentUser) {
                    alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                    return;
                }

                // ì±„íŒ… ë©”ì‹œì§€ ì „ì†¡ (ì„œë²„ë¡œ AJAX ìš”ì²­)
                const senderId = currentUser.useridx;
                const senderName = currentUser.userName;

                $('.chat-messages').append(`
                <div class="sender-message">
                <strong>${senderName}</strong>: ${message}
                </div>
            `);

                $('#chat-message').val('');

                $.ajax({
                    url: '/api/chat/send',  // ì±„íŒ… ë©”ì‹œì§€ ì „ì†¡ API
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        sender: { useridx: senderId },
                        receiver: { useridx: receiverId },
                        message: message
                    }),
                    success: function (response) {
                        // ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€ ì¶”ê°€
                        $('.chat-messages').append('<div class="sender-message">' + response.message + '</div>');
                        $('#chat-message').val('');  // ë©”ì‹œì§€ ì…ë ¥ì°½ ì´ˆê¸°í™”
                    },
                    error: function () {
                        alert('ë©”ì‹œì§€ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                });

            });
        });

        // ìª½ì§€ 
        let currentUser = null; // ğŸ”¹ ì„¸ì…˜ ë¡œê·¸ì¸ ì‚¬ìš©ì ì €ì¥ìš©

        $(document).ready(function () {
            // ğŸ”¸ ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ì •ë³´ ìš”ì²­
            $.ajax({
                url: '/api/session-user',
                method: 'GET',
                success: function (user) {
                    currentUser = user;
                    $('#login-btn').hide();  // ë¡œê·¸ì¸ëœ ê²½ìš° ë¡œê·¸ì¸ ë²„íŠ¼ ìˆ¨ê¹€
                },
                error: function (xhr) {
                    if (xhr.status === 401) {
                        // ë¡œê·¸ì¸ ì•ˆí•œ ìƒíƒœ
                        currentUser = null;
                        $('.note-toggle-btn').hide();
                        $('.chat-toggle-btn').hide();
                        $('#login-btn').show();  // ë¡œê·¸ì¸ ë²„íŠ¼ í‘œì‹œ
                    }
                }
            });

            $('#login-btn').on('click', function () {
                window.location.href = '/login';
            });

            // ğŸ”¸ ìª½ì§€ íŒì—… ì—´ê¸°
            $('.note-toggle-btn').on('click', function () {
                if (!currentUser) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    return;
                }

                $.ajax({
                    url: `/api/notes/received/${currentUser.userid}`,
                    method: 'GET',
                    success: function (response) {
                        const template = `
                        {{#notes}}
                        <div class="note-item" data-note-id="{{id}}">
                            <span class="sender">ë³´ë‚¸ ì‚¬ëŒ: {{senderId}}</span>
                            <div class="message">{{message}}</div>
                            <div class="timestamp">{{timestamp}}</div>
                        </div>
                        {{/notes}}
                    `;
                        const rendered = Mustache.render(template, { notes: response });
                        $('.note-messages').html(rendered);
                        $('.note-popup').fadeIn();
                    },
                    error: function () {
                        alert('ìª½ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                });
            });

            // ìª½ì§€ ì°½ ë‹«ê¸°
            $('.note-close-btn').on('click', function () {
                $('.note-popup').fadeOut();  // ìª½ì§€ íŒì—… ë‹«ê¸°
            });

            // ìª½ì§€ í´ë¦­ ì‹œ ìƒì„¸ ë‚´ìš© í‘œì‹œ
            $(document).on('click', '.note-item', function () {
                const noteId = $(this).data('note-id');

                // ì„ íƒí•œ ìª½ì§€ì˜ IDë¥¼ í†µí•´ ìƒì„¸ ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” API í˜¸ì¶œ
                $.ajax({
                    url: `/api/notes/${noteId}`,  // ìª½ì§€ ìƒì„¸ ë‚´ìš© ì¡°íšŒ API
                    method: 'GET',
                    success: function (response) {
                        const template = `
                            {{#notes}}
                            <div class="note-item" data-note-id="{{noteId}}">
                                <span class="sender">ë³´ë‚¸ ì‚¬ëŒ: {{senderId}}</span>
                                <div class="message">{{message}}</div>
                                <div class="timestamp">{{timestamp}}</div>
                            </div>
                            {{/notes}}
                        `;

                        const rendered = Mustache.render(template, { notes: response });
                        $('.note-messages').html(rendered);
                    },
                    error: function () {
                        alert('ìª½ì§€ ìƒì„¸ ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                    }
                });
            });

        });

        $('#send-note').on('click', function () {
            const message = $('#note-message').val().trim();
            const receiverId = $('#note-receiver').val().trim();

            if (!message) {
                alert('ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            if (!receiverId) {
                alert('ë°›ëŠ” ì‚¬ëŒ ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            if (!currentUser) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }

            $.ajax({
                url: '/api/notes/send',  // ìª½ì§€ ì „ì†¡ API ì—”ë“œí¬ì¸íŠ¸
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    senderId: currentUser.userid,  // ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ID
                    receiverId: receiverId,
                    message: message
                }),
                success: function (response) {
                    alert('ìª½ì§€ê°€ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    $('#note-message').val('');  // ì…ë ¥ì°½ ì´ˆê¸°í™”
                    // í•„ìš”ì‹œ ë°›ì€ ìª½ì§€ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ ë“± ì¶”ê°€ ì²˜ë¦¬
                },
                error: function () {
                    alert('ìª½ì§€ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            });

        });



        $('.received-notes-btn').on('click', function () {
            if (!currentUser) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }

            $.ajax({
                url: `/api/notes/received/${currentUser.userid}`,  // ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ID ì§ì ‘ ì‚¬ìš©
                method: 'GET',
                success: function (data) {
                    const $noteMessages = $('.note-messages');
                    $noteMessages.empty();

                    if (data.length === 0) {
                        $noteMessages.append('<div class="note-item">ë°›ì€ ìª½ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</div>');
                        return;
                    }

                    data.forEach(note => {
                        const item = `
                    <div class="note-item">
                        <div class="sender">${note.senderId}</div>
                        <div class="message">${note.message}</div>
                        <div class="timestamp">${note.timestamp || ''}</div>
                    </div>`;
                        $noteMessages.append(item);
                    });
                },
                error: function () {
                    alert('ë°›ì€ ìª½ì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            });
        });

    </script>
</body>

</html>
